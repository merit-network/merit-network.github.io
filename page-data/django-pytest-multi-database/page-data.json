{"componentChunkName":"component---src-templates-blog-post-js","path":"/django-pytest-multi-database/","result":{"data":{"site":{"siteMetadata":{"author":{"name":"Merit Open Source and Technology"},"title":"Merit Network, Inc. Open Source and Technology"}},"markdownRemark":{"id":"bd2b6a15-8873-5d87-abd1-8bf253720111","excerpt":"UPDATE: 2021-05-10 The pytest-django team is actively working on resolving this issue! üéâ Nearly the same day we put this up they started merging duplicate‚Ä¶","html":"<h1>UPDATE: 2021-05-10</h1>\n<p><strong>The pytest-django team is actively working on resolving this issue!</strong> üéâ Nearly the same day we put this up they started merging duplicate tickets and even have an initial PR!</p>\n<p>View/track progress at:</p>\n<ul>\n<li>Issue: <a href=\"https://github.com/pytest-dev/pytest-django/issues/924\">https://github.com/pytest-dev/pytest-django/issues/924</a></li>\n<li>PR: <a href=\"https://github.com/pytest-dev/pytest-django/pull/930\">https://github.com/pytest-dev/pytest-django/pull/930</a></li>\n</ul>\n<p>Until an official solution lands feel free to follow this article. Once there‚Äôs an official solution we would <em>strongly</em> encourage using it!</p>\n<h1>What‚Äôs the problem?</h1>\n<p><a href=\"https://www.djangoproject.com/\">Django</a>, <a href=\"https://docs.pytest.org/\">pytest</a>, and <a href=\"https://pytest-django.readthedocs.io/en/latest/\">pytest-django</a> are awesome and work very well together when you have a single database and/or use a single, temporary test database that is created and destroyed every test run.</p>\n<p>If you have multiple (test) databases that persist before/after test runs you may find that your test data remains for all databases that aren‚Äôt named ‚Äúdefault‚Äù.</p>\n<p>This can lead to all sorts of issues with tests and isn‚Äôt great when you have shared test databases.</p>\n<h1>pytest-django doesn‚Äôt support multi-db rollback</h1>\n<p>When setting up the database fixtures (<code class=\"language-text\">db</code>, <code class=\"language-text\">transactional_db</code>) pytest-django makes use of <a href=\"https://docs.djangoproject.com/en/3.2/topics/testing/tools/#transactiontestcase\"><code class=\"language-text\">TransactionTestCase</code></a> or <a href=\"https://docs.djangoproject.com/en/3.2/topics/testing/tools/#testcase\"><code class=\"language-text\">TestCase</code></a>. Both of these use transactions under the hood and while they may also do things atomically the big difference is that one truncates all tables while the other resets state after each test.</p>\n<p>The challenge in using these with pytest-django is that <code class=\"language-text\">TransactionTestCase</code> and <code class=\"language-text\">TestCase</code> are hard-coded to only work with the default database via <code class=\"language-text\">DEFAULT_DB_ALIAS</code> (<em>see this at <a href=\"https://github.com/django/django/blob/main/django/test/testcases.py#L927\">https://github.com/django/django/blob/main/django/test/testcases.py#L927</a></em>).</p>\n<p>Because of the hard-coded <code class=\"language-text\">DEFAULT_DB_ALIAS</code> any database that isn‚Äôt the default won‚Äôt have rollback and will persist any changes made during tests.</p>\n<p><strong>This is less an issue with pytest-django and more an issue with hard-coded defaults in Django‚Äôs test classes.</strong> Django expects you to provide the DB names for test cases as-needed in a multi-database test setup (<em>see <a href=\"https://docs.djangoproject.com/en/3.2/topics/testing/tools/#testing-multi-db\">https://docs.djangoproject.com/en/3.2/topics/testing/tools/#testing-multi-db</a></em>) but because we aren‚Äôt directly sub-classing test cases we can‚Äôt specify our databases.</p>\n<h1>Using pytest fixtures to patch Django‚Äôs test classes</h1>\n<p><strong>The fix for this is pretty simple!</strong> We‚Äôre going to use a pytest fixture that‚Äôll patch Django‚Äôs test classes to support all databases defined in Django‚Äôs settings.</p>\n<p>Assuming you already have pytest and pytest-django setup and working this is all you need to add to your base <code class=\"language-text\">conftest.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pytest\n\n\n<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>autouse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> scope<span class=\"token operator\">=</span><span class=\"token string\">'session'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">django_db_multiple</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Ensure all test functions using Django test cases have\n    multiple database rollback support.\n    \"\"\"</span>\n    <span class=\"token keyword\">from</span> _pytest<span class=\"token punctuation\">.</span>monkeypatch <span class=\"token keyword\">import</span> MonkeyPatch\n    <span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>conf <span class=\"token keyword\">import</span> settings\n    <span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>test <span class=\"token keyword\">import</span> TestCase\n    <span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>test <span class=\"token keyword\">import</span> TransactionTestCase\n\n    db_keys <span class=\"token operator\">=</span> <span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>settings<span class=\"token punctuation\">.</span>DATABASES<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    monkeypatch <span class=\"token operator\">=</span> MonkeyPatch<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    monkeypatch<span class=\"token punctuation\">.</span><span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>TestCase<span class=\"token punctuation\">,</span> <span class=\"token string\">'databases'</span><span class=\"token punctuation\">,</span> db_keys<span class=\"token punctuation\">)</span>\n    monkeypatch<span class=\"token punctuation\">.</span><span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>TransactionTestCase<span class=\"token punctuation\">,</span> <span class=\"token string\">'databases'</span><span class=\"token punctuation\">,</span> db_keys<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">yield</span> monkeypatch\n\n    monkeypatch<span class=\"token punctuation\">.</span>undo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>All set!</strong> You now have rollback support for all databases. You don‚Äôt need to do anything else and can get back to writing tests. Any changes you make in your tests will be rolled back across all of your databases.</p>\n<p>This works by replacing the hard-coded default <code class=\"language-text\">DEFAULT_DB_ALIAS</code> with the database names defined in your settings. Because it‚Äôs an <code class=\"language-text\">autouse</code>, session-scoped fixture in your base configuration it‚Äôll be run once automatically and persist for all tests.</p>\n<h1>Other solutions and discussions</h1>\n<p>There isn‚Äôt yet a consensus on how best to do this and there isn‚Äôt yet an official solution. What we‚Äôre using is based on comments and direction from contributors to pytest-django but there‚Äôs always more than one way to do things.</p>\n<p>For alternative solutions and more discussion:</p>\n<ul>\n<li><a href=\"https://github.com/pytest-dev/pytest-django/issues/76\">https://github.com/pytest-dev/pytest-django/issues/76</a></li>\n<li><a href=\"https://github.com/pytest-dev/pytest/issues/1872\">https://github.com/pytest-dev/pytest/issues/1872</a></li>\n</ul>\n<p><em>Have a better way? Disagree? <a href=\"https://github.com/merit-network/merit-network.github.io/issues\">Let us know</a>!</em></p>","frontmatter":{"date":"July 05, 2021","description":"Adding multi-database rollback support to pytest-django using fixtures that patch Django's test classes.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQL/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAABv1s406Kn/8QAGRAAAwEBAQAAAAAAAAAAAAAAAAECETJB/9oACAEBAAEFAneO6wT08jo//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BJ//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/AWf/xAAXEAEAAwAAAAAAAAAAAAAAAAAQACGB/9oACAEBAAY/ApTh/8QAHBAAAgICAwAAAAAAAAAAAAAAATEAERAhQVGh/9oACAEBAAE/IVNmulNIM15ABKFhxN7F4//aAAwDAQACAAMAAAAQk8//xAAWEQEBAQAAAAAAAAAAAAAAAAABEFH/2gAIAQMBAT8QAi5P/8QAFhEBAQEAAAAAAAAAAAAAAAAAARBR/9oACAECAQE/EEiGz//EABwQAQADAQEAAwAAAAAAAAAAAAEAESFRMXGhwf/aAAgBAQABPxAgAQ11xvKm2O7BZQ/X1LcJZiceTwBYbOzLsBvzVx9n/9k=","aspectRatio":1.7543859649122806,"src":"/static/f61159864add0e89dbcb391cfd657c7d/14b42/vincent-van-zalinge-4Mu2bXIsn5Y-unsplash.jpg","srcSet":"/static/f61159864add0e89dbcb391cfd657c7d/f836f/vincent-van-zalinge-4Mu2bXIsn5Y-unsplash.jpg 200w,\n/static/f61159864add0e89dbcb391cfd657c7d/2244e/vincent-van-zalinge-4Mu2bXIsn5Y-unsplash.jpg 400w,\n/static/f61159864add0e89dbcb391cfd657c7d/14b42/vincent-van-zalinge-4Mu2bXIsn5Y-unsplash.jpg 800w,\n/static/f61159864add0e89dbcb391cfd657c7d/a7715/vincent-van-zalinge-4Mu2bXIsn5Y-unsplash.jpg 1000w","sizes":"(max-width: 800px) 100vw, 800px"}}},"featuredImageCredit":"Vincent van Zalinge","featuredImageLink":"https://unsplash.com/photos/4Mu2bXIsn5Y","tags":["django","database","oracle","oracle database","pytest"],"title":"Rollback Multiple Test Databases in Django with Pytest","postAuthor":null}}},"pageContext":{"slug":"/django-pytest-multi-database/","previous":{"fields":{"slug":"/arcade-nested-relationship/"},"frontmatter":{"title":"Arcade Pop-up for Nested Relationships and Duplicate Fields"}},"next":{"fields":{"slug":"/gathering-ba-requirements/"},"frontmatter":{"title":"Gathering Business Analysis Requirement"}}}},"staticQueryHashes":["1265084305","1540936805","1598440204","3333504701"]}