{"componentChunkName":"component---src-templates-blog-post-js","path":"/summarize_within_median_r_arcgis/","result":{"data":{"site":{"siteMetadata":{"author":{"name":"Merit Open Source and Technology"},"title":"Merit Network, Inc. Open Source and Technology"}},"markdownRemark":{"id":"cea041bb-c0ce-530d-a49d-789c05f0a98b","excerpt":"If you’ve ever longed for ‘median’ as an option in the dropdown list of Esri’s ‘Summarize Within’ tool when working with non-normally distributed data, long no…","html":"<p><em>If you’ve ever longed for ‘median’ as an option in the dropdown list of Esri’s ‘Summarize Within’ tool when working with non-normally distributed data, long no more! Use this script and the R-ArcGIS Bridge to fulfill your non-parametric function needs.</em></p>\n<h1>TL;DR</h1>\n<p>When your data is not normally distributed, look outside the limited dropdown options for a solution that maintains the integrity of your data. The R-ArcGIS Bridge provides the ability to use R in scripting a statistical model (in this case calculating the median value based on geographic location) and ArcGIS Pro to run and incorporate the script into your larger Esri workflow.</p>\n<h1>Why would I need something other than the options Esri provides?</h1>\n<p>Have you ever been working on a project in ArcGIS Pro, realized you had skewed data, and then further realized ArcGIS Pro’s ‘Summarize Within’ tool limits you to a few options meant for normally distributed data? I certainly have. Rather than shrug your shoulders and think ‘ah well, the mean value is close enough…’ see if you can find a way to use a more appropriate statistical test.</p>\n<p>To put this idea in some context, I’m working on a current project gathering granular internet speed test results and then aggregating those granular speed tests up to the census block level. When looking at the distribution of internet speeds within geographic buckets, you’ll see that the distribution is highly skewed. A lot of the internet users may hang out around the 25 - 75 MBPS range for download speed, some may be at the 0 MBPS range, and then a smaller, but still substantial group, jump up to that 1G category, resulting in some major outliers, large tails, and large peaks.</p>\n<p>There is no question that this data does not satisfy the requirements of normally distributed data, meaning we should <strong><em>not</em></strong> use a parametric test (e.g. <code class=\"language-text\">mean</code>) to analyze the data. Using the <code class=\"language-text\">mean</code> function when aggregating these values up to the census block level would artificially push your average towards those outliers, misrepresenting what the ‘average’ person in that census block is really experiencing. When the purpose of this analysis is to provide data-driven insight into where new broadband infrastructure investments should be made, pushing the metric towards those high outliers is absolutely unacceptable. Fortunately, the median value of your data provides one option to better represent the true middle ground of what users on the ground are experiencing.</p>\n<p>This particular project has many components and is largely working in ArcGIS Pro’s model builder with some deeper statistics and figure generation happening in RStudio. Our goal is to have cohesion between these two programs, so we did not want a workflow that required us to run some analysis in ArcGIS Pro, leave this program and open up RStudio to run a custom-made script, and then go back into ArcGIS Pro to run the rest of the model. Luckily, Esri’s R-ArcGIS Bridge allows us to create the custom tool you’ll see below and then import that into the ArcGIS Pro interface whenever we want to calculate the median download and upload speeds for each census block in our study area.</p>\n<h1>R-ArcGIS Bridge provides a solution</h1>\n<p>In this post I’m going to focus more on the actual script to calculate the median values, with some callouts to the R-ArcGIS Bridge components. To use this solution, you will need the following installed:</p>\n<ul>\n<li>R and Rstudio 3.5 or later (<a href=\"https://rstudio-education.github.io/hopr/starting.html\">https://rstudio-education.github.io/hopr/starting.html</a>)</li>\n<li>ArcGIS Pro 2.2 or later</li>\n</ul>\n<p>If you’re new to the concept of the R-ArcGIS Bridge, you can fnd more detail here: <a href=\"https://github.com/R-ArcGIS/r-bridge-install\">https://github.com/R-ArcGIS/r-bridge-install</a>.</p>\n<h1>Let’s break down the code</h1>\n<p>You’ll need to first call the function that will allow you to bring this tool into ArcGIS Pro as a custom script that will prompt the user for input:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">tool_exec <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>in_params<span class=\"token punctuation\">,</span> out_params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"token comment\">#The rest of the code below goes in here</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We’ll need the following R packages and code to initialize the R-ArcGIS bridge:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">require<span class=\"token punctuation\">(</span>sp<span class=\"token punctuation\">)</span> <span class=\"token comment\">#classes and methods for spatial data, https://cran.r-project.org/web/packages/sp/index.html</span>\nrequire<span class=\"token punctuation\">(</span>spatialEco<span class=\"token punctuation\">)</span> <span class=\"token comment\">#needed for the point.in.polygon() function, https://cran.r-project.org/web/packages/spatialEco/index.html</span>\nrequire<span class=\"token punctuation\">(</span>arcgisbinding<span class=\"token punctuation\">)</span> <span class=\"token comment\">#initializes the R-ArcGIS bridge and connects your Esri license info</span>\n\n<span class=\"token comment\">#tie your license into the session</span>\narc.check_product<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now we define the input and output parameters you want the user to provide via the tool interface in ArcGIS Pro:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  polygon_input <span class=\"token operator\">&lt;-</span> in_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#in this case, the census blocks</span>\n  point_input <span class=\"token operator\">&lt;-</span> in_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#in this case, the points with the speed test data</span>\n  attribute_input <span class=\"token operator\">&lt;-</span> in_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#this must be the EXACT name of the field in the data table</span>\n  attribute_groupby <span class=\"token operator\">&lt;-</span> in_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#this must be the EXACT name of the field in the data table</span>\n  coord_system <span class=\"token operator\">&lt;-</span> in_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#user chooses Point or Polygon from dropdown for the coordinate system they want to use</span>\n\n  summarized_output <span class=\"token operator\">&lt;-</span> out_params<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#this is user provided</span>\n  Output_FC <span class=\"token operator\">&lt;-</span> out_params <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#this is derived</span></code></pre></div>\n<p>Ok, now we need to convert the user inputs to strings so that they will work properly in the rest of the script:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  polygon_input <span class=\"token operator\">&lt;-</span> toString<span class=\"token punctuation\">(</span>polygon_input<span class=\"token punctuation\">)</span>\n  point_input <span class=\"token operator\">&lt;-</span> toString<span class=\"token punctuation\">(</span>point_input<span class=\"token punctuation\">)</span>\n  attribute_input <span class=\"token operator\">&lt;-</span> toString<span class=\"token punctuation\">(</span>attribute_input<span class=\"token punctuation\">)</span>\n  attribute_groupby <span class=\"token operator\">&lt;-</span> toString<span class=\"token punctuation\">(</span>attribute_groupby<span class=\"token punctuation\">)</span>\n  summarized_output <span class=\"token operator\">&lt;-</span> toString<span class=\"token punctuation\">(</span>summarized_output<span class=\"token punctuation\">)</span></code></pre></div>\n<p>We’re now going to read in the GIS feature class, via <code class=\"language-text\">arc.open()</code>, and in the same line transform that into a data frame, via <code class=\"language-text\">arc.select()</code>, so we can work with it in R:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  poly.df <span class=\"token operator\">&lt;-</span> arc.select<span class=\"token punctuation\">(</span>arc.open<span class=\"token punctuation\">(</span>polygon_input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  point.df <span class=\"token operator\">&lt;-</span> arc.select<span class=\"token punctuation\">(</span>arc.open<span class=\"token punctuation\">(</span>point_input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  print<span class=\"token punctuation\">(</span><span class=\"token string\">\"Polygon and point data have been converted to data frames\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>If we were just importing the feature class into RStudio to derive non-spatial statistics, we could stop at the data frame conversion. Since we will be perfoming spatial statistics, meaning that the actual location of the features is the prominent piece of the analysis (e.g. summarizing the median value of points residing inside a polygon vs answering the question ‘what is the median value of all survey responses’) one more conversion is needed. We need to convert the data frames into a <strong><em>SpatialPointsDataFrame</em></strong> and a <strong><em>SpatialPolygonDataFrame</em></strong> using the <code class=\"language-text\">sp package</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  poly.spdf <span class=\"token operator\">&lt;-</span> arc.data2sp<span class=\"token punctuation\">(</span>poly.df<span class=\"token punctuation\">)</span>\n  point.spdf <span class=\"token operator\">&lt;-</span> arc.data2sp<span class=\"token punctuation\">(</span>point.df<span class=\"token punctuation\">)</span>\n\n  print<span class=\"token punctuation\">(</span><span class=\"token string\">\"Data has been converted to spatial data frames\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Before we can do any analysis between these two spatial data frames we need to ensure their projections match. At the top we have the user choose if they want the resulting feature class to be of the coordinate system of the point or polygon feature class. We’re assuming at least one of these feature classes has the desired coordinate system for output.</p>\n<p>For reference, the <code class=\"language-text\">spTransform()</code> function performs the actual projection and datum transformation and the <code class=\"language-text\">CRS()</code> function grabs the projection info of the input feature class as a class <strong><em>character</em></strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  <span class=\"token comment\">#grab projection information of each spatial data frame as a string</span>\n  point_proj <span class=\"token operator\">&lt;-</span> proj4string<span class=\"token punctuation\">(</span>point.spdf<span class=\"token punctuation\">)</span>\n  poly_proj <span class=\"token operator\">&lt;-</span> proj4string<span class=\"token punctuation\">(</span>poly.spdf<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">#check if the coordinate systems match, if they don't then reproject one based on user input</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>point_proj<span class=\"token operator\">!=</span>poly_proj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>coord_system<span class=\"token operator\">==</span><span class=\"token string\">\"Point\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      poly.spdf <span class=\"token operator\">&lt;-</span> spTransform<span class=\"token punctuation\">(</span>poly.spdf<span class=\"token punctuation\">,</span> CRS<span class=\"token punctuation\">(</span>point_proj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n      point.spdf <span class=\"token operator\">&lt;-</span> spTransform<span class=\"token punctuation\">(</span>point.spdf<span class=\"token punctuation\">,</span> CRS<span class=\"token punctuation\">(</span>poly.spdf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\nprint<span class=\"token punctuation\">(</span><span class=\"token string\">\"Coordinate systems have been checked and updated if necessary\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now we can finally get to the exciting part and do some stats! We’re going to attach a polygon ID to each point and then aggregate the median value of each point with the same polygon ID.</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  <span class=\"token comment\">#attach polygon attributes to each point, allowing for aggregation of a point numeric value by a polygon ID</span>\n  pts.poly <span class=\"token operator\">&lt;-</span> point.<span class=\"token keyword\">in</span>.poly<span class=\"token punctuation\">(</span>point.spdf<span class=\"token punctuation\">,</span>poly.spdf<span class=\"token punctuation\">)</span>\n\n   <span class=\"token comment\">#summarize points based on polygon ID via user input and update column names</span>\n  summarized_median <span class=\"token operator\">&lt;-</span> aggregate<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span>pts.poly<span class=\"token operator\">@</span>data<span class=\"token punctuation\">[</span>attribute_input<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> by<span class=\"token operator\">=</span>list<span class=\"token punctuation\">(</span>pts.poly<span class=\"token operator\">@</span>data<span class=\"token punctuation\">[</span> <span class=\"token punctuation\">,</span>attribute_groupby<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FUN<span class=\"token operator\">=</span>median<span class=\"token punctuation\">,</span> drop<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n  colnames<span class=\"token punctuation\">(</span>summarized_median<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;-</span>c<span class=\"token punctuation\">(</span>attribute_groupby<span class=\"token punctuation\">,</span>paste<span class=\"token punctuation\">(</span><span class=\"token string\">\"Median\"</span><span class=\"token punctuation\">,</span>attribute_input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  print<span class=\"token punctuation\">(</span><span class=\"token string\">\"Median values aggregated\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We also will want the total number of points in each census block for a more robust understanding of our median metric:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  <span class=\"token comment\">#count total amount of points within each polygon based on ID supplied by user</span>\n  summarized_count <span class=\"token operator\">&lt;-</span> aggregate<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span>pts.poly<span class=\"token operator\">@</span>data<span class=\"token punctuation\">[</span>attribute_input<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> by<span class=\"token operator\">=</span>list<span class=\"token punctuation\">(</span>pts.poly<span class=\"token operator\">@</span>data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> attribute_groupby<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FUN<span class=\"token operator\">=</span>length<span class=\"token punctuation\">,</span> drop<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n  colnames<span class=\"token punctuation\">(</span>summarized_count<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;-</span>c<span class=\"token punctuation\">(</span>attribute_groupby<span class=\"token punctuation\">,</span><span class=\"token string\">\"Total Point Count\"</span><span class=\"token punctuation\">)</span>\n\n  print<span class=\"token punctuation\">(</span><span class=\"token string\">\"Total count aggregated\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>To finish, we need to merge these outputs together and write the data to an Esri feature class:</p>\n<div class=\"gatsby-highlight\" data-language=\"r\"><pre class=\"language-r\"><code class=\"language-r\">  <span class=\"token comment\">#merge median and count together into one table</span>\n  summarized_merged <span class=\"token operator\">&lt;-</span> merge<span class=\"token punctuation\">(</span>summarized_median<span class=\"token punctuation\">,</span> summarized_count<span class=\"token punctuation\">,</span>by<span class=\"token operator\">=</span>attribute_groupby<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">#join table back to SpatialPolygonsDataFrame</span>\n  new_poly_spdf <span class=\"token operator\">&lt;-</span> merge<span class=\"token punctuation\">(</span>poly.spdf<span class=\"token punctuation\">,</span> summarized_merged<span class=\"token punctuation\">,</span>by<span class=\"token operator\">=</span>attribute_groupby<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">#export to feature class</span>\n  Output_FC <span class=\"token operator\">&lt;-</span> arc.write<span class=\"token punctuation\">(</span>summarized_output<span class=\"token punctuation\">,</span> new_poly_spdf<span class=\"token punctuation\">)</span></code></pre></div>\n<p>That’s all the code! If you want to test this in RStudio before bringing it into ArcGIS Pro, simply comment out the initial function definition and parameter definitions, define the parameters as variables with the same name as the parameter definition, and run the code from there.</p>\n<p>For more information on creating a custom tool from your script in ArcGIS Pro, visit this site: <a href=\"https://pro.arcgis.com/en/pro-app/latest/arcpy/geoprocessing_and_python/adding-a-script-tool.htm\">https://pro.arcgis.com/en/pro-app/latest/arcpy/geoprocessing_and_python/adding-a-script-tool.htm</a></p>\n<h1>Closing thoughts</h1>\n<p>At the end of the day it is so important to stay true to your data, even if that means stepping outside of the preconfigured dropdowns your software provides. Some of the time your data may be normally distributed and you can use ArcGIS Pro’s ‘Summarize Within’ with no issues. In the cases where your data is non-parametric, doing a bit of extra work to seek out a non-parametic solution will maintain the integrity of your data and the R-ArcGIS Bridge makes this so much more doable.</p>\n<p>It is also worth noting that there are other way to deal with non-normally distributed data, such as removing outliers or transforming your data, that may work better for your specific project. The most important rule of thumb is to always use your brain first about what works best for the intended use of that data.</p>\n<p>Have a better way? Disagree? <a href=\"https://github.com/merit-network/merit-network.github.io/issues\">Let us know</a>!</p>","frontmatter":{"date":"January 29, 2021","description":"Learn how to summarize the median value of your point features within a polygon feature class in ArcGIS Pro using the R-ArcGIS bridge.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMCBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGG+OkpEf/EABsQAAICAwEAAAAAAAAAAAAAAAECAxIAESIx/9oACAEBAAEFAo259MvDq2gJ64zXP//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/AYf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAZEAADAQEBAAAAAAAAAAAAAAAAAREhAlH/2gAIAQEABj8C30iISDnK0sP/xAAbEAADAQEAAwAAAAAAAAAAAAAAAREhMUFRwf/aAAgBAQABPyHK+Gy6b8kvR4IsHHVoxE9hrJjRFD//2gAMAwEAAgADAAAAEPDf/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8QpH//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxCq/8QAHxABAAIBAwUAAAAAAAAAAAAAAQARITFBUWGxwfDx/9oACAEBAAE/ELUlACgADywKQqoOw6wgJcVeWBVRrFv8gR1rWTvKoloFfdZ//9k=","aspectRatio":1.5037593984962405,"src":"/static/93240834c54740674edbf20f5b3b1ffd/14b42/nathan-dumlao-qq9XjVZe4Lk-unsplash.jpg","srcSet":"/static/93240834c54740674edbf20f5b3b1ffd/f836f/nathan-dumlao-qq9XjVZe4Lk-unsplash.jpg 200w,\n/static/93240834c54740674edbf20f5b3b1ffd/2244e/nathan-dumlao-qq9XjVZe4Lk-unsplash.jpg 400w,\n/static/93240834c54740674edbf20f5b3b1ffd/14b42/nathan-dumlao-qq9XjVZe4Lk-unsplash.jpg 800w,\n/static/93240834c54740674edbf20f5b3b1ffd/42364/nathan-dumlao-qq9XjVZe4Lk-unsplash.jpg 1100w","sizes":"(max-width: 800px) 100vw, 800px"}}},"featuredImageCredit":"Nathan Dumlao","featuredImageLink":"https://unsplash.com/photos/qq9XjVZe4Lk","tags":["gis","R","Esri","ArcGIS Pro","statistics"],"title":"Summarize Median Values in ArcGIS Pro via R-ArcGIS Bridge"}}},"pageContext":{"slug":"/summarize_within_median_r_arcgis/","previous":{"fields":{"slug":"/how-to-fail-gracefully/"},"frontmatter":{"title":"How to Fail Gracefully"}},"next":{"fields":{"slug":"/arcade-nested-relationship/"},"frontmatter":{"title":"Arcade Pop-up for Nested Relationships and Duplicate Fields"}}}},"staticQueryHashes":["1265084305","1540936805","1598440204","3333504701"]}